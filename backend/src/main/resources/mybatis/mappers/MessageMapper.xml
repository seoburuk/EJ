<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.Globalin.dao.MessageDao">

    <resultMap id="MessageResultMap" type="com.example.Globalin.model.Message">
        <id property="id" column="id"/>
        <result property="senderId" column="sender_id"/>
        <result property="receiverId" column="receiver_id"/>
        <result property="title" column="title"/>
        <result property="content" column="content"/>
        <result property="isRead" column="is_read"/>
        <result property="createdAt" column="created_at"/>
        <result property="deletedBySender" column="deleted_by_sender"/>
        <result property="deletedByReceiver" column="deleted_by_receiver"/>
        <result property="senderNickname" column="sender_nickname"/>
        <result property="receiverNickname" column="receiver_nickname"/>
    </resultMap>

    <!-- メッセージ送信 -->
    <insert id="insertMessage" parameterType="com.example.Globalin.model.Message"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO messages (sender_id, receiver_id, title, content)
        VALUES (#{senderId}, #{receiverId}, #{title}, #{content})
    </insert>

    <!-- メッセージ取得 -->
    <select id="findById" parameterType="long" resultMap="MessageResultMap">
        SELECT m.*,
               s.nickname as sender_nickname,
               r.nickname as receiver_nickname
        FROM messages m
        LEFT JOIN users s ON m.sender_id = s.id
        LEFT JOIN users r ON m.receiver_id = r.id
        WHERE m.id = #{id}
    </select>

    <!-- 受信メッセージリスト取得 -->
    <select id="findReceivedMessages" resultMap="MessageResultMap">
        SELECT m.*,
               s.nickname as sender_nickname,
               r.nickname as receiver_nickname
        FROM messages m
        LEFT JOIN users s ON m.sender_id = s.id
        LEFT JOIN users r ON m.receiver_id = r.id
        WHERE m.receiver_id = #{userId}
          AND m.deleted_by_receiver = FALSE
        ORDER BY m.created_at DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 送信メッセージリスト取得 -->
    <select id="findSentMessages" resultMap="MessageResultMap">
        SELECT m.*,
               s.nickname as sender_nickname,
               r.nickname as receiver_nickname
        FROM messages m
        LEFT JOIN users s ON m.sender_id = s.id
        LEFT JOIN users r ON m.receiver_id = r.id
        WHERE m.sender_id = #{userId}
          AND m.deleted_by_sender = FALSE
        ORDER BY m.created_at DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 受信メッセージ数取得 -->
    <select id="countReceivedMessages" resultType="int">
        SELECT COUNT(*)
        FROM messages
        WHERE receiver_id = #{userId}
          AND deleted_by_receiver = FALSE
    </select>

    <!-- 送信メッセージ数取得 -->
    <select id="countSentMessages" resultType="int">
        SELECT COUNT(*)
        FROM messages
        WHERE sender_id = #{userId}
          AND deleted_by_sender = FALSE
    </select>

    <!-- 未読メッセージ数取得 -->
    <select id="countUnreadMessages" resultType="int">
        SELECT COUNT(*)
        FROM messages
        WHERE receiver_id = #{userId}
          AND is_read = FALSE
          AND deleted_by_receiver = FALSE
    </select>

    <!-- メッセージ既読処理 -->
    <update id="markAsRead">
        UPDATE messages
        SET is_read = TRUE
        WHERE id = #{id}
    </update>

    <!-- 送信者が削除 -->
    <update id="deleteForSender">
        UPDATE messages
        SET deleted_by_sender = TRUE
        WHERE id = #{id}
    </update>

    <!-- 受信者が削除 -->
    <update id="deleteForReceiver">
        UPDATE messages
        SET deleted_by_receiver = TRUE
        WHERE id = #{id}
    </update>

    <!-- 実際の削除（両方が削除した場合） -->
    <delete id="deleteMessage">
        DELETE FROM messages
        WHERE id = #{id}
          AND deleted_by_sender = TRUE
          AND deleted_by_receiver = TRUE
    </delete>

</mapper>
